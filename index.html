<!DOCTYPE html>
<html>
  <head>
    <title>MapLeaflet Advanced</title>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- Leaflet CSS/JS -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.7.1/leaflet.css" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.7.1/leaflet.js"></script>
    <!-- Leaflet.draw CSS/JS -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.css" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.js"></script>
    <!-- Leaflet.curve JS for bezier curves -->
    <script src="https://unpkg.com/leaflet.curve@0.2.0/leaflet.curve.js"></script>
    <!-- Leaflet.DistortableImage CSS/JS for draggable/resizable overlays -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet-distortableimage@0.2.0/dist/leaflet.distortableimage.css" />
    <script src="https://unpkg.com/leaflet-distortableimage@0.2.0/dist/leaflet.distortableimage.js"></script>
    <!-- Mouse position control -->
    <link rel="stylesheet" href="https://cdn.rawgit.com/ardhi/Leaflet.MousePosition/master/src/L.Control.MousePosition.css" />
    <script src="https://cdn.rawgit.com/ardhi/Leaflet.MousePosition/master/src/L.Control.MousePosition.js"></script>
    <style>
      html, body, #map {
        width: 100%; height: 100%; margin: 0; padding: 0; background: #1e1e1e;
      }
      /* Dark cartography-style UI for panels */
      .panel {
        position: absolute; background: #2d2d2d; color: #ddd; padding: 10px; border-radius: 5px;
        box-shadow: 0 0 8px rgba(0,0,0,0.7); z-index: 1000; font-family: sans-serif;
      }
      #marker-panel { top: 10px; left: 10px; width: 220px; }
      #overlay-panel { top: 250px; left: 10px; width: 220px; }
      #draw-panel { top: 490px; left: 10px; width: 220px; }
      #layer-panel { top: 10px; right: 10px; width: 240px; max-height: 80%; overflow-y: auto; }
      #save-load-panel { top: 650px; right: 10px; width: 240px; }
      .panel h4 { margin: 0 0 8px; }
      .panel input, .panel button, .panel select {
        width: 100%; margin-bottom: 8px; padding: 4px; border: 1px solid #555; background: #444; color: #ddd;
      }
      .layer-item { margin-bottom: 5px; border-bottom: 1px solid #555; padding-bottom: 5px; }
      .layer-item button { margin-right: 2px; }
      .custom-marker .marker-label {
        background: #444; padding: 4px 8px; border: 1px solid #888; border-radius: 3px; font-size: 14px; color: #ddd;
      }
    </style>
  </head>
  <body>
    <div id="map"></div>
    <!-- Marker Panel -->
    <div id="marker-panel" class="panel">
      <h4>Marker Tool</h4>
      <input type="text" id="label-text" placeholder="Label text">
      <input type="text" id="label-description" placeholder="Description (optional)">
      <input type="text" id="custom-icon" placeholder="Icon URL or emoji">
      <input type="file" id="icon-file" accept="image/png">
      <button onclick="startAddingMarker()">Add Marker (Click on map)</button>
    </div>
    <!-- Overlay Panel -->
    <div id="overlay-panel" class="panel">
      <h4>Overlay Tool</h4>
      <input type="file" id="overlay-file" accept="image/png">
      <button onclick="uploadOverlay()">Upload New Overlay</button>
    </div>
    <!-- Draw Panel -->
    <div id="draw-panel" class="panel">
      <h4>Border Brush</h4>
      <input type="color" id="border-color" value="#ff0000">
      <button onclick="startDrawingBorder()">Draw Border</button>
      <button onclick="editBorders()">Edit Borders</button>
      <button onclick="smoothBorders()">Smooth Border</button>
    </div>
    <!-- Layer Panel -->
    <div id="layer-panel" class="panel">
      <h4>Layers</h4>
      <div id="layers-list"></div>
    </div>
    <!-- Save/Load Panel -->
    <div id="save-load-panel" class="panel">
      <h4>Save / Load</h4>
      <button onclick="saveLayers()">Save Layers</button>
      <button onclick="loadLayers()">Load Layers</button>
    </div>
    <script>
      // Map setup with simple CRS
      var mapExtent = [0, -8436, 14999, 0];
      var mapMinZoom = 0, mapMaxZoom = 4, mapMaxResolution = 2, mapMinResolution = Math.pow(2, mapMaxZoom) * mapMaxResolution;
      var crs = L.CRS.Simple;
      crs.transformation = new L.Transformation(1, -mapExtent[0], -1, mapExtent[3]);
      crs.scale = function(zoom) { return Math.pow(2, zoom) / mapMinResolution; };
      crs.zoom = function(scale) { return Math.log(scale * mapMinResolution) / Math.LN2; };
      var map = new L.Map('map', { maxZoom: mapMaxZoom, minZoom: mapMinZoom, crs: crs });
      // Base Layer (added to layerList as a base layer)
      var baseLayer = L.tileLayer('{z}/{x}/{y}.png', {
        minZoom: mapMinZoom, maxZoom: mapMaxZoom, tileSize: L.point(512,512),
        attribution: '<a href="https://www.maptiler.com/engine/">Rendered with MapTiler Engine</a>, non-commercial use only',
        noWrap: true, tms: false
      }).addTo(map);
      map.fitBounds([ crs.unproject(L.point(mapExtent[2], mapExtent[3])), crs.unproject(L.point(mapExtent[0], mapExtent[1])) ]);
      L.control.mousePosition().addTo(map);
      
      // Global layers
      var customMarkerLayer = L.layerGroup().addTo(map);
      var drawnBordersLayer = L.featureGroup().addTo(map);
      var overlayLayers = []; // For distortable overlays
      // Layer list for UI (base layer is fixed at bottom)
      var layerList = [
        { id: 'baseLayer', name: 'Base Layer', layer: baseLayer, fixed: true },
        { id: 'customMarkers', name: 'Custom Markers', layer: customMarkerLayer },
        { id: 'drawnBorders', name: 'Borders', layer: drawnBordersLayer }
      ];
      overlayLayers.forEach(function(ol) { layerList.push(ol); });
      updateLayerPanel();
      
      // Handle custom marker icon file upload
      var uploadedIconDataURL = null;
      document.getElementById("icon-file").addEventListener("change", function(e) {
        var file = e.target.files[0];
        if (file) {
          var reader = new FileReader();
          reader.onload = function(evt) { uploadedIconDataURL = evt.target.result; };
          reader.readAsDataURL(file);
        }
      });
      
      // Update layer panel UI
      function updateLayerPanel() {
        var container = document.getElementById("layers-list");
        container.innerHTML = "";
        layerList.forEach(function(item, index) {
          var div = document.createElement("div");
          div.className = "layer-item";
          var chk = document.createElement("input");
          chk.type = "checkbox";
          chk.checked = map.hasLayer(item.layer);
          chk.onchange = function() { chk.checked ? map.addLayer(item.layer) : map.removeLayer(item.layer); };
          div.appendChild(chk);
          var span = document.createElement("span");
          span.innerHTML = " " + item.name + (item.fixed ? " (Fixed)" : "");
          div.appendChild(span);
          if (!item.fixed) {
            if (index > 0) {
              var upBtn = document.createElement("button");
              upBtn.innerHTML = "↑";
              upBtn.onclick = function() {
                var temp = layerList[index - 1];
                layerList[index - 1] = item;
                layerList[index] = temp;
                item.layer.bringToFront();
                updateLayerPanel();
              };
              div.appendChild(upBtn);
            }
            if (index < layerList.length - 1) {
              var downBtn = document.createElement("button");
              downBtn.innerHTML = "↓";
              downBtn.onclick = function() {
                var temp = layerList[index + 1];
                layerList[index + 1] = item;
                layerList[index] = temp;
                item.layer.bringToFront();
                updateLayerPanel();
              };
              div.appendChild(downBtn);
            }
          }
          container.appendChild(div);
        });
      }
      
      // Marker tool: start adding marker on map click
      function startAddingMarker() {
        var labelText = document.getElementById("label-text").value;
        var description = document.getElementById("label-description").value;
        var customIconInput = document.getElementById("custom-icon").value;
        if (!labelText) { alert("Please enter a label text"); return; }
        alert("Click on the map to add the marker.");
        map.once('click', function(event) {
          addCustomMarker(event.latlng, labelText, description, customIconInput);
        });
      }
      function addCustomMarker(latlng, labelText, description, customIconInput) {
        var markerOptions = {};
        if (uploadedIconDataURL) {
          markerOptions.icon = L.icon({ iconUrl: uploadedIconDataURL, iconSize: [32,32], iconAnchor: [16,32] });
          uploadedIconDataURL = null;
          document.getElementById("icon-file").value = "";
        } else if (customIconInput) {
          if (customIconInput.startsWith("http")) {
            markerOptions.icon = L.icon({ iconUrl: customIconInput, iconSize: [32,32], iconAnchor: [16,32] });
          } else {
            markerOptions.icon = L.divIcon({ html: '<div style="font-size:24px;">' + customIconInput + '</div>', className: '', iconSize: [32,32], iconAnchor: [16,16] });
          }
        } else {
          markerOptions.icon = L.divIcon({ html: '<div class="marker-label">' + labelText + '</div>', className: 'custom-marker', iconSize: [100,40] });
        }
        var marker = L.marker(latlng, markerOptions);
        var popupContent = '<strong>' + labelText + '</strong>' + (description ? '<br/>' + description : '');
        marker.bindPopup(popupContent);
        marker.addTo(customMarkerLayer).openPopup();
      }
      
      // Overlay tool: upload overlay image and add as distortable overlay that fills map bounds
      function uploadOverlay() {
        var fileInput = document.getElementById("overlay-file");
        var file = fileInput.files[0];
        if (!file) { alert("Select an overlay PNG file."); return; }
        var reader = new FileReader();
        reader.onload = function(evt) {
          var dataURL = evt.target.result;
          var bounds = map.getBounds();
          var overlay = L.distortableImageOverlay(dataURL, bounds, { interactive: true }).addTo(map);
          var overlayId = 'overlay_' + (overlayLayers.length + 1);
          overlayLayers.push({ id: overlayId, layer: overlay });
          layerList.push({ id: overlayId, name: 'Overlay ' + overlayLayers.length, layer: overlay });
          updateLayerPanel();
          fileInput.value = "";
        };
        reader.readAsDataURL(file);
      }
      
      // Draw tool: initialize Leaflet.draw for borders (editable and smoothable)
      var drawControl = new L.Control.Draw({
        draw: { circle: false, marker: false, rectangle: false, polyline: false, circlemarker: false,
          polygon: { allowIntersection: false, showArea: true, drawError: { color: '#e1e100', message: '<strong>Error:<strong> shape not allowed' } }
        },
        edit: { featureGroup: drawnBordersLayer }
      });
      map.addControl(drawControl);
      map.on(L.Draw.Event.CREATED, function(e) {
        var layerDrawn = e.layer;
        var color = document.getElementById("border-color").value;
        layerDrawn.setStyle({ color: color, weight: 3 });
        drawnBordersLayer.addLayer(layerDrawn);
        updateLayerPanel();
      });
      function editBorders() {
        // Enable editing on drawn borders
        drawnBordersLayer.eachLayer(function(layer) { layer.editing.enable(); });
      }
      // Smooth borders using a simple Chaikin's algorithm
      function smoothBorders() {
        drawnBordersLayer.eachLayer(function(layer) {
          if (layer instanceof L.Polygon) {
            var coords = layer.getLatLngs()[0];
            var newCoords = [];
            for (var i = 0; i < coords.length - 1; i++) {
              var p0 = coords[i], p1 = coords[i+1];
              var Q = L.latLng(0.75 * p0.lat + 0.25 * p1.lat, 0.75 * p0.lng + 0.25 * p1.lng);
              var R = L.latLng(0.25 * p0.lat + 0.75 * p1.lat, 0.25 * p0.lng + 0.75 * p1.lng);
              newCoords.push(Q, R);
            }
            newCoords.push(newCoords[0]);
            layer.setLatLngs([newCoords]);
          }
        });
      }
      
      // Save and load layers to/from localStorage
      function saveLayers() {
        var data = {};
        data.customMarkers = [];
        customMarkerLayer.eachLayer(function(marker) {
          data.customMarkers.push({ lat: marker.getLatLng().lat, lng: marker.getLatLng().lng, popup: marker.getPopup().getContent() });
        });
        data.drawnBorders = drawnBordersLayer.toGeoJSON();
        data.overlays = [];
        overlayLayers.forEach(function(ol) {
          var bounds = ol.layer.getBounds();
          data.overlays.push({ dataURL: ol.layer._url || ol.layer.options.url || ol.layer._image.src, bounds: bounds.toBBoxString() });
        });
        localStorage.setItem("mapLayers", JSON.stringify(data));
        alert("Layers saved.");
      }
      function loadLayers() {
        var data = JSON.parse(localStorage.getItem("mapLayers"));
        if (!data) { alert("No saved layers found."); return; }
        customMarkerLayer.clearLayers();
        drawnBordersLayer.clearLayers();
        overlayLayers.forEach(function(ol) { map.removeLayer(ol.layer); });
        overlayLayers = [];
        layerList = layerList.filter(function(item) { return item.fixed || item.id !== undefined && item.id.indexOf('overlay_') === -1; });
        data.customMarkers.forEach(function(m) {
          var marker = L.marker([m.lat, m.lng]);
          marker.bindPopup(m.popup);
          marker.addTo(customMarkerLayer);
        });
        L.geoJSON(data.drawnBorders).eachLayer(function(layer) {
          drawnBordersLayer.addLayer(layer);
        });
        data.overlays.forEach(function(olData, idx) {
          var b = olData.bounds.split(',').map(Number);
          var bounds = L.latLngBounds(L.latLng(b[1], b[0]), L.latLng(b[3], b[2]));
          var overlay = L.distortableImageOverlay(olData.dataURL, bounds, { interactive: true }).addTo(map);
          var overlayId = 'overlay_' + (idx + 1);
          overlayLayers.push({ id: overlayId, layer: overlay });
          layerList.push({ id: overlayId, name: 'Overlay ' + (idx + 1), layer: overlay });
        });
        updateLayerPanel();
        alert("Layers loaded.");
      }
      
      // Update layer panel initially
      updateLayerPanel();
    </script>
  </body>
</html>
